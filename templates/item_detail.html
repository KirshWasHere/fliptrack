{% extends "base.html" %}

{% block title %}{{ item.item_name }} - FlipTrack{% endblock %}

{% block content %}
{% set total_expenses = item.purchase_price + item.shipping_cost + item.get('listing_fee', 0) + item.get('processing_fee', 0) + item.get('storage_cost', 0) + item.get('other_expenses', 0) %}
{% set potential_profit = item.target_price - total_expenses %}
{% set actual_profit = (item.final_sold_price - total_expenses) if item.final_sold_price else 0 %}

<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-start">
        <div>
            <h1 class="text-3xl font-bold text-white">{{ item.item_name }}</h1>
            <p class="text-dark-muted mt-1">Item #{{ item.id }} â€¢ {{ item.category }}</p>
        </div>
        <div class="flex gap-2">
            <a href="/item/{{ item.id }}/edit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                Edit
            </a>
            <button onclick="deleteItem({{ item.id }})" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                Delete
            </button>
        </div>
    </div>

    <!-- Status Badge -->
    <div>
        <span class="px-3 py-1 text-sm font-semibold rounded-full 
            {% if item.status == 'Sold' %}bg-green-900 text-green-300
            {% elif item.status == 'Listed' %}bg-blue-900 text-blue-300
            {% else %}bg-yellow-900 text-yellow-300{% endif %}">
            {{ item.status }}
        </span>
    </div>

    <!-- Profit Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
            <div class="text-dark-muted text-sm">Total Expenses</div>
            <div class="text-2xl font-bold text-white mt-2">${{ "%.2f"|format(total_expenses) }}</div>
        </div>
        <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
            <div class="text-dark-muted text-sm">Potential Profit</div>
            <div class="text-2xl font-bold {% if potential_profit >= 0 %}text-green-400{% else %}text-red-400{% endif %} mt-2">
                ${{ "%.2f"|format(potential_profit) }}
            </div>
        </div>
        {% if item.status == 'Sold' and item.final_sold_price %}
        <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
            <div class="text-dark-muted text-sm">Actual Profit</div>
            <div class="text-2xl font-bold {% if actual_profit >= 0 %}text-green-400{% else %}text-red-400{% endif %} mt-2">
                ${{ "%.2f"|format(actual_profit) }}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Details Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Pricing Info -->
        <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
            <h2 class="text-xl font-bold text-white mb-4">Pricing</h2>
            <div class="space-y-3">
                <div class="flex justify-between">
                    <span class="text-dark-muted">Purchase Price:</span>
                    <span class="text-white font-medium">${{ "%.2f"|format(item.purchase_price) }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-dark-muted">Shipping Cost:</span>
                    <span class="text-white font-medium">${{ "%.2f"|format(item.shipping_cost) }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-dark-muted">Listing Fee:</span>
                    <span class="text-white font-medium">${{ "%.2f"|format(item.get('listing_fee', 0)) }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-dark-muted">Processing Fee:</span>
                    <span class="text-white font-medium">${{ "%.2f"|format(item.get('processing_fee', 0)) }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-dark-muted">Storage Cost:</span>
                    <span class="text-white font-medium">${{ "%.2f"|format(item.get('storage_cost', 0)) }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-dark-muted">Other Expenses:</span>
                    <span class="text-white font-medium">${{ "%.2f"|format(item.get('other_expenses', 0)) }}</span>
                </div>
                <div class="border-t border-dark-border pt-3 flex justify-between">
                    <span class="text-white font-bold">Target Price:</span>
                    <span class="text-white font-bold">${{ "%.2f"|format(item.target_price) }}</span>
                </div>
                {% if item.final_sold_price %}
                <div class="flex justify-between">
                    <span class="text-green-400 font-bold">Final Sold Price:</span>
                    <span class="text-green-400 font-bold">${{ "%.2f"|format(item.final_sold_price) }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Item Details -->
        <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
            <h2 class="text-xl font-bold text-white mb-4">Details</h2>
            <div class="space-y-3">
                {% if item.condition %}
                <div>
                    <span class="text-dark-muted">Condition:</span>
                    <span class="text-white ml-2">{{ item.condition }}</span>
                </div>
                {% endif %}
                {% if item.storage_location %}
                <div>
                    <span class="text-dark-muted">Storage:</span>
                    <span class="text-white ml-2">{{ item.storage_location }}</span>
                </div>
                {% endif %}
                {% if item.tags %}
                <div>
                    <span class="text-dark-muted">Tags:</span>
                    <div class="mt-1 flex flex-wrap gap-2">
                        {% for tag in item.tags.split(',') %}
                        <span class="px-2 py-1 bg-dark-bg text-dark-text text-xs rounded">{{ tag.strip() }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                {% if provider %}
                <div>
                    <span class="text-dark-muted">Provider:</span>
                    <a href="/provider/{{ provider.id }}" class="text-blue-400 hover:text-blue-300 ml-2">{{ provider.name }}</a>
                </div>
                {% endif %}
                {% if item.sales_channel %}
                <div>
                    <span class="text-dark-muted">Sales Channel:</span>
                    <span class="text-white ml-2">{{ item.sales_channel }}</span>
                </div>
                {% endif %}
                {% if item.product_url %}
                <div>
                    <span class="text-dark-muted">Product URL:</span>
                    <a href="{{ item.product_url }}" target="_blank" class="text-blue-400 hover:text-blue-300 ml-2 break-all">
                        {{ item.product_url[:50] }}...
                    </a>
                </div>
                {% endif %}
                {% if item.listing_url %}
                <div>
                    <span class="text-dark-muted">Listing URL:</span>
                    <a href="{{ item.listing_url }}" target="_blank" class="text-blue-400 hover:text-blue-300 ml-2 break-all">
                        {{ item.listing_url[:50] }}...
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Notes -->
    {% if item.notes %}
    <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
        <h2 class="text-xl font-bold text-white mb-4">Notes</h2>
        <p class="text-dark-text">{{ item.notes }}</p>
    </div>
    {% endif %}

    <!-- Images -->
    {% if item.selected_images %}
    <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
        <h2 class="text-xl font-bold text-white mb-4">Images</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
            {% for img_path in item.selected_images %}
            <img src="/static/{{ img_path }}" alt="Item image" class="rounded-lg border border-dark-border">
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Report -->
    {% if item.report_path %}
    <div class="bg-dark-surface border border-dark-border rounded-lg p-6">
        <h2 class="text-xl font-bold text-white mb-4">Report</h2>
        <a href="/{{ item.report_path }}" target="_blank" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md inline-block">
            View HTML Report
        </a>
    </div>
    {% endif %}
</div>

<script>
function deleteItem(itemId) {
    if (confirm('Are you sure you want to delete this item? This cannot be undone.')) {
        fetch(`/item/${itemId}/delete`, { method: 'POST' })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/items';
                } else {
                    alert('Failed to delete item');
                }
            });
    }
}
</script>
{% endblock %}
